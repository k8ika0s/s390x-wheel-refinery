<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Wheel Refinery History</title>
    <style>
      body { font-family: Arial, sans-serif; margin: 24px; background: #0f172a; color: #e2e8f0; }
      h1, h2 { margin-bottom: 8px; }
      a { color: #38bdf8; text-decoration: none; }
      a:hover { text-decoration: underline; }
      .section { margin-bottom: 24px; }
      .card { background: #1e293b; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; }
      .status { font-weight: bold; }
      .status.built { color: #22c55e; }
      .status.failed { color: #f87171; }
      .status.missing { color: #fbbf24; }
      .status.reused, .status.cached { color: #a3e635; }
      .status.system_recipe_failed { color: #fb7185; }
      .meta { font-size: 12px; color: #cbd5e1; }
      .list { display: grid; gap: 8px; }
      .two-col { display: grid; gap: 16px; grid-template-columns: 1fr 1fr; }
      .bar { height: 12px; background: linear-gradient(90deg, #38bdf8, #22c55e); border-radius: 6px; }
      .bar-container { background: #1e293b; border-radius: 6px; padding: 4px; }
      .chart { background: #1e293b; padding: 12px; border-radius: 8px; }
      .button { padding:6px 10px;border:1px solid #38bdf8;border-radius:6px;background:#0ea5e9;color:#0f172a;font-weight:bold;cursor:pointer; }
      .button:disabled { opacity:0.5; cursor:not-allowed; }
    </style>
  </head>
  <body>
    <h1>Wheel Refinery History</h1>
    <form method="get" action="/" style="margin-bottom:12px;">
      <input type="text" name="package" placeholder="filter package" value="{{ package_filter }}" style="padding:6px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;">
      <input type="text" name="status" placeholder="status (built,failed,...)" value="{{ status_filter }}" style="padding:6px;border-radius:6px;border:1px solid #334155;background:#0f172a;color:#e2e8f0;">
      <button type="submit" style="padding:6px 10px;border:1px solid #38bdf8;border-radius:6px;background:#0ea5e9;color:#0f172a;font-weight:bold;">Filter</button>
    </form>
    <div class="card">
      <h2>Live log tail</h2>
      <pre id="live-log" style="max-height:200px;"></pre>
    </div>
    <div class="two-col">
      <div class="section">
        <h2>Recent events</h2>
        <div class="list">
          {% for event in recent %}
          <div class="card">
            <div>
              <span class="status {{ event.status }}">{{ event.status }}</span>
              {{ event.name }} {{ event.version }}
            </div>
            <div class="meta">{{ event.python_tag }}/{{ event.platform_tag }} | {{ event.timestamp }}</div>
            {% if event.detail %}<div class="meta">detail: {{ event.detail }}</div>{% endif %}
            {% if event.metadata.hint %}<div class="meta">hint: {{ event.metadata.hint }}</div>{% endif %}
            {% if event.metadata.duration_seconds %}<div class="meta">duration: {{ event.metadata.duration_seconds }}s</div>{% endif %}
            {% if event.wheel_path %}<div class="meta">wheel: {{ event.wheel_path }}</div>{% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
      <div class="section">
        <h2>Retry queue</h2>
        <div class="card">
          <div class="meta">Queue length: <span id="queue-length">{{ queue_length }}</span></div>
          <div class="meta">Worker mode: {{ worker_mode or 'unavailable' }}</div>
          {% if worker_mode %}
            <button id="trigger-worker" class="button" type="button">Run worker now</button>
            <div id="worker-status" class="meta"></div>
          {% else %}
            <div class="meta">Worker not configured (set WORKER_WEBHOOK_URL or WORKER_* paths).</div>
          {% endif %}
        </div>
        <h2>Top failures</h2>
        <div class="list">
          {% for fail in failures %}
          <div class="card">
            <div><a href="/package/{{ fail.name }}">{{ fail.name }}</a></div>
            <div class="meta">{{ fail.failures }} failures</div>
            <div class="bar-container">
              <div class="bar" style="width: {{ 10 + fail.failures * 5 }}px;"></div>
            </div>
          </div>
          {% endfor %}
        </div>
        <h2>Top slow packages</h2>
        <div class="list">
          {% for slow in slowest %}
          <div class="card">
            <div><a href="/package/{{ slow.name }}">{{ slow.name }}</a></div>
            <div class="meta">avg duration: {{ slow.avg_duration }}s | failures: {{ slow.failures }}</div>
            <div class="bar-container">
              <div class="bar" style="width: {{ slow.avg_duration * 5 }}px;"></div>
            </div>
          </div>
          {% endfor %}
        </div>
        <h2>Hint catalog</h2>
        <div class="list">
          {% for hint in hint_catalog %}
          <div class="card">
            <div class="meta">pattern: {{ hint.pattern }}</div>
            <div class="meta">dnf: {{ hint.packages.get('dnf', []) }}</div>
            <div class="meta">apt: {{ hint.packages.get('apt', []) }}</div>
          </div>
          {% endfor %}
        </div>
        <h2>Status counts (recent)</h2>
        <div class="chart">
          {% for status, count in status_counts.items() %}
          <div class="meta">{{ status }}: {{ count }}</div>
          <div class="bar-container">
            <div class="bar" style="width: {{ 10 + count * 8 }}px;"></div>
          </div>
          {% endfor %}
        </div>
        <h2>Recent failures</h2>
        <div class="list">
          {% for event in recent_failures %}
          <div class="card">
            <div><span class="status {{ event.status }}">{{ event.status }}</span> {{ event.name }} {{ event.version }}</div>
            <div class="meta">{{ event.timestamp }}</div>
            {% if event.metadata.hint %}<div class="meta">hint: {{ event.metadata.hint }}</div>{% endif %}
          </div>
          {% endfor %}
        </div>
      </div>
    </div>
    <script>
      const liveEl = document.getElementById('live-log');
      if (liveEl) {
        // Simple stream of the most recent log if present
        fetch('/api/recent?limit=1')
          .then(r => r.json())
          .then(events => {
            if (!events.length || !events[0].metadata || !events[0].metadata.log_path) return;
            const evtSource = new EventSource(`/logs/${events[0].name}/${events[0].version}/stream`);
            evtSource.onmessage = (e) => {
              liveEl.textContent += e.data + "\\n";
              liveEl.scrollTop = liveEl.scrollHeight;
            };
            evtSource.onerror = () => evtSource.close();
          });
      }
      const triggerBtn = document.getElementById('trigger-worker');
      if (triggerBtn) {
        triggerBtn.addEventListener('click', () => {
          triggerBtn.disabled = true;
          const headers = {};
          const token = getCookie('worker_token');
          if (token) headers['X-Worker-Token'] = token;
          fetch('/api/worker/trigger', {method: 'POST', headers})
            .then(r => r.json())
            .then(data => {
              document.getElementById('worker-status').textContent = data.detail || JSON.stringify(data);
              if (data.queue_length !== undefined) {
                document.getElementById('queue-length').textContent = data.queue_length;
              }
            })
            .catch(() => { document.getElementById('worker-status').textContent = 'Failed to trigger worker'; })
            .finally(() => { triggerBtn.disabled = false; });
        });
      }
      function getCookie(name) {
        const value = `; ${document.cookie}`;
        const parts = value.split(`; ${name}=`);
        if (parts.length === 2) return parts.pop().split(';').shift();
      }
    </script>
  </body>
</html>
