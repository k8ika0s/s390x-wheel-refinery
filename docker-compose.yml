version: "3.9"

services:
  api:
    build:
      context: .
      dockerfile: containers/web/Dockerfile
    container_name: refinery-api
    environment:
      HISTORY_DB: /cache/history.db
      WORKER_WEBHOOK_URL: http://worker:9000/trigger
      WORKER_TOKEN: ${WORKER_TOKEN:-changeme}
    ports:
      - "8000:8000"
    volumes:
      - ./input:/input:ro
      - ./output:/output
      - ./cache:/cache
    depends_on:
      - worker

  worker:
    build:
      context: .
      dockerfile: containers/web/Dockerfile
    container_name: refinery-worker
    command: ["uvicorn", "s390x_wheel_refinery.worker_service:app", "--host", "0.0.0.0", "--port", "9000"]
    environment:
      HISTORY_DB: /cache/history.db
      WORKER_INPUT_DIR: /input
      WORKER_OUTPUT_DIR: /output
      WORKER_CACHE_DIR: /cache
      WORKER_PYTHON: "3.11"
      WORKER_PLATFORM_TAG: "manylinux2014_s390x"
      WORKER_TOKEN: ${WORKER_TOKEN:-changeme}
    ports:
      - "9000:9000"
    volumes:
      - ./input:/input:ro
      - ./output:/output
      - ./cache:/cache

  ui:
    build:
      context: .
      dockerfile: containers/ui/Dockerfile
      args:
        VITE_API_BASE: http://api:8000
    container_name: refinery-ui
    environment:
      NODE_ENV: production
    ports:
      - "3000:80"
    depends_on:
      - api

volumes:
  input:
  output:
  cache:
